<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Notulen RSUD dr. R. Koesma</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Identity Services (Untuk Login) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .rs-green { color: #166534; }
        .bg-rs-green { background-color: #166534; }
        .loading-overlay { background: rgba(255, 255, 255, 0.9); z-index: 100; }
        /* Animasi */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

    <!-- ================= LOGIN VIEW ================= -->
    <div id="login-view" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-br from-green-50 to-green-100 fade-in">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-white/50 backdrop-blur-sm">
            <div class="mb-6 flex justify-center">
                <div class="bg-green-100 p-4 rounded-full">
                    <i class="fa-solid fa-hospital-user text-5xl rs-green"></i>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">E-Notulen RSUD</h1>
            <p class="text-gray-500 mb-8 text-sm">Silakan login menggunakan akun Google Instansi atau Pribadi untuk mengakses sistem.</p>
            
            <!-- Tombol Google Login -->
            <!-- PENTING: GANTI 'YOUR_GOOGLE_CLIENT_ID_PLACEHOLDER' DENGAN CLIENT ID ASLI ANDA -->
            <div id="g_id_onload"
                 data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="pill"
                 data-theme="outline"
                 data-text="signin_with"
                 data-size="large"
                 data-logo_alignment="left"
                 data-width="320">
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <p class="text-xs text-gray-400">RSUD dr. R. Koesma Tuban &copy; 2024</p>
            </div>
        </div>
    </div>

    <!-- ================= APP VIEW (Hidden by default) ================= -->
    <div id="app-view" class="hidden flex-col min-h-screen fade-in">
        
        <!-- Navbar -->
        <nav class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <i class="fa-solid fa-hospital-user text-2xl rs-green mr-3"></i>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800 leading-tight">E-Notulen</h1>
                            <p class="text-[10px] text-gray-500 font-medium tracking-wide">RSUD dr. R. KOESMA</p>
                        </div>
                    </div>
                    
                    <!-- User Profile & Logout -->
                    <div class="flex items-center gap-4">
                        <div class="hidden md:flex flex-col items-end">
                            <span id="user-name" class="text-sm font-semibold text-gray-700">User Name</span>
                            <span id="user-email" class="text-xs text-gray-500">user@example.com</span>
                        </div>
                        <img id="user-avatar" src="" alt="Profile" class="h-9 w-9 rounded-full border border-gray-300 shadow-sm">
                        <button onclick="logout()" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-full transition ml-1" title="Keluar">
                            <i class="fa-solid fa-arrow-right-from-bracket text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8 max-w-5xl">

            <!-- Navigation Tabs -->
            <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg px-4 pt-4 shadow-sm">
                <button onclick="switchTab('input')" id="tab-input" class="py-3 px-6 border-b-2 font-medium text-sm focus:outline-none border-green-600 text-green-600 transition-colors">
                    <i class="fa-solid fa-pen-to-square mr-2"></i> Input Data
                </button>
                <button onclick="switchTab('list')" id="tab-list" class="py-3 px-6 border-b-2 font-medium text-sm focus:outline-none border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                    <i class="fa-solid fa-list mr-2"></i> Arsip Notulen
                </button>
            </div>

            <!-- FORM INPUT VIEW -->
            <div id="view-input" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6 md:p-8 animate-fade-in">
                <form id="notulenForm" onsubmit="submitForm(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Unit / Bagian</label>
                            <div class="relative">
                                <select name="unit" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500 appearance-none bg-white">
                                    <option value="">-- Pilih Unit --</option>
                                    <option value="Direksi">Jajaran Direksi</option>
                                    <option value="Yanmed">Pelayanan Medis</option>
                                    <option value="Keperawatan">Keperawatan</option>
                                    <option value="Penunjang">Penunjang Medis</option>
                                    <option value="Umum & Kepegawaian">Umum & Kepegawaian</option>
                                    <option value="Keuangan">Keuangan</option>
                                    <option value="Komite Medis">Komite Medis</option>
                                    <option value="Komite Mutu">Komite Mutu</option>
                                    <option value="Instalasi IT">Instalasi SIMRS (IT)</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Rapat</label>
                            <input type="date" name="tanggal" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Agenda / Judul Rapat</label>
                        <input type="text" name="agenda" placeholder="Contoh: Rapat Koordinasi Bulanan" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Peserta Hadir (Ringkasan)</label>
                        <input type="text" name="peserta" placeholder="Sebutkan jabatan atau nama..." class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Isi Pembahasan & Keputusan</label>
                        <textarea name="isi" rows="8" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Tuliskan poin-poin hasil rapat..."></textarea>
                    </div>

                    <div class="mb-8 bg-green-50 p-5 rounded-lg border border-green-100">
                        <label class="block text-sm font-bold text-green-800 mb-2 flex items-center">
                            <i class="fa-solid fa-clipboard-check mr-2"></i> Tindak Lanjut (Action Plan)
                        </label>
                        <textarea name="tindakLanjut" rows="3" class="w-full rounded-lg border border-green-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500 bg-white" placeholder="Siapa melakukan apa, kapan deadline-nya?"></textarea>
                    </div>

                    <div class="flex justify-end pt-4 border-t border-gray-100">
                        <button type="submit" class="bg-rs-green text-white px-8 py-3 rounded-lg hover:bg-green-800 transition shadow-lg flex items-center font-medium transform active:scale-95">
                            <i class="fa-solid fa-paper-plane mr-2"></i> Simpan Notulen
                        </button>
                    </div>
                </form>
            </div>

            <!-- LIST ARCHIVE VIEW -->
            <div id="view-list" class="hidden bg-white shadow rounded-b-lg rounded-tr-lg p-6 animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Arsip Notulen</h2>
                    <button onclick="loadData()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition text-sm font-medium">
                        <i class="fa-solid fa-arrows-rotate mr-1"></i> Refresh
                    </button>
                </div>
                
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Unit</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Agenda</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tindak Lanjut</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                                    <p>Klik tombol Refresh untuk memuat data.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- DETAIL MODAL (Pop-up Detail Notulen) -->
    <div id="modal-detail" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-start bg-gray-50 rounded-t-xl">
                <div>
                    <h3 class="text-xl font-bold text-gray-800" id="detail-agenda">Agenda Rapat</h3>
                    <div class="flex items-center gap-2 mt-2">
                        <span id="detail-unit" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-semibold">Unit</span>
                        <span id="detail-tanggal" class="text-gray-500 text-sm"><i class="fa-regular fa-calendar mr-1"></i> Tanggal</span>
                    </div>
                </div>
                <button onclick="closeDetail()" class="text-gray-400 hover:text-red-500 transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2 border-b pb-1">Peserta</h4>
                    <p id="detail-peserta" class="text-gray-600 text-sm leading-relaxed"></p>
                </div>
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2 border-b pb-1">Isi Pembahasan</h4>
                    <div id="detail-isi" class="text-gray-800 whitespace-pre-line leading-relaxed bg-gray-50 p-4 rounded-lg border border-gray-100"></div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-green-700 uppercase tracking-wide mb-2 border-b border-green-100 pb-1">Tindak Lanjut</h4>
                    <div id="detail-tindak" class="text-gray-800 bg-green-50 p-4 rounded-lg border border-green-100 italic"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl text-right">
                <button onclick="closeDetail()" class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition shadow-sm font-medium">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 loading-overlay flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-green-600 mb-4"></div>
        <p class="text-gray-600 font-medium animate-pulse">Memproses Data...</p>
    </div>

    <script>
        // ==========================================
        // KONFIGURASI MANUAL
        // ==========================================
        
        // 1. URL Web App Google Apps Script telah dimasukkan secara otomatis:
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzj1mWjE3EC2KmtKbaHoz8yNEcnNFffDKXJ2xQg0mAKsSBB9QWGtIfwDw65z0OnnHWV/exec"; 

        // 2. PENTING: Jangan lupa mengganti 'YOUR_GOOGLE_CLIENT_ID_PLACEHOLDER' 
        //    di bagian HTML (baris ~41) dengan Client ID Google Anda sendiri.

        // ==========================================
        // LOGIC AUTHENTICATION & APP
        // ==========================================

        let currentUser = null;

        // Cek Login Saat Load
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('rsud_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showLogin();
            }
        });

        // Callback dari Google Sign-In
        function handleCredentialResponse(response) {
            // Decode JWT Token
            const responsePayload = parseJwt(response.credential);
            
            // Simpan data user
            currentUser = {
                name: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture
            };
            
            localStorage.setItem('rsud_user', JSON.stringify(currentUser));
            showApp();
        }

        // Tampilkan Aplikasi
        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('flex');
            
            // Set User Info di Navbar
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').src = currentUser.picture;
        }

        // Tampilkan Login
        function showLogin() {
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('flex');
            document.getElementById('login-view').classList.remove('hidden');
        }

        // Logout
        function logout() {
            localStorage.removeItem('rsud_user');
            currentUser = null;
            showLogin();
            // Opsional: Reload halaman agar bersih
            // window.location.reload();
        }

        // Helper: Parse JWT dari Google
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // ==========================================
        // LOGIC NOTULEN APP (Sama seperti sebelumnya)
        // ==========================================

        function switchTab(tabName) {
            ['input', 'list'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.remove('border-green-600', 'text-green-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-green-600', 'text-green-600');
            
            if(tabName === 'list') loadData();
        }

        function submitForm(e) {
            e.preventDefault();
            
            // Validasi URL Script
            if (!SCRIPT_URL) {
                alert("ERROR KONFIGURASI: URL Script belum diatur.");
                return;
            }

            const form = document.getElementById('notulenForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Tambahkan data pencatat (User yang sedang login)
            if (currentUser) {
                data.pencatatNama = currentUser.name;
                data.pencatatEmail = currentUser.email;
            }

            toggleLoading(true);

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                toggleLoading(false);
                if(result.status === 'success') {
                    alert("✅ Notulen berhasil disimpan!");
                    form.reset();
                    switchTab('list');
                } else {
                    alert("❌ Gagal: " + result.message);
                }
            })
            .catch(err => {
                toggleLoading(false);
                alert("❌ Kesalahan Jaringan. Pastikan URL API benar.");
                console.error(err);
            });
        }

        function loadData() {
            if (!SCRIPT_URL) {
                document.getElementById('table-body').innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500 font-bold">URL Script belum dikonfigurasi di source code!</td></tr>`;
                return;
            }

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2 text-green-600"></i><p>Mengambil data terbaru...</p></td></tr>`;

            fetch(`${SCRIPT_URL}?action=read`)
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    renderTable(response.data);
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500 font-medium">Error: ${response.message}</td></tr>`;
                }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal terhubung ke database.</td></tr>`;
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400 bg-gray-50">Belum ada data notulen tersimpan.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const itemSafe = encodeURIComponent(JSON.stringify(item));
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition duration-150";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.tanggal}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">${item.unit}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">${item.agenda}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs">${item.tindakLanjut || '<span class="text-gray-300">-</span>'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openDetail('${itemSafe}')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 px-3 py-1 rounded transition">
                            Lihat
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Modal Logic
        function openDetail(itemStr) {
            const item = JSON.parse(decodeURIComponent(itemStr));
            document.getElementById('detail-agenda').textContent = item.agenda;
            document.getElementById('detail-unit').textContent = item.unit;
            document.getElementById('detail-tanggal').textContent = item.tanggal;
            document.getElementById('detail-peserta').textContent = item.peserta || "-";
            document.getElementById('detail-isi').textContent = item.isi;
            document.getElementById('detail-tindak').textContent = item.tindakLanjut || "Tidak ada catatan tindak lanjut.";
            document.getElementById('modal-detail').classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('modal-detail').classList.add('hidden');
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading');
            el.classList.toggle('hidden', !show);
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modalDetail = document.getElementById('modal-detail');
            if (event.target == modalDetail) closeDetail();
        }
    </script>
</body>

</html>
